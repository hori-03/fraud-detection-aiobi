{% extends "base.html" %}

{% block title %}Statistiques - Aïobi{% endblock %}

{% block content %}
<div class="container-aiobi fade-in">
    <!-- Header -->
    <div class="flex items-center justify-between mb-8">
        <div>
            <h1 class="text-3xl font-bold text-white flex items-center">
                <i class="fas fa-chart-bar mr-3 text-green-500"></i>
                Statistiques et Analyses
            </h1>
            <p class="text-gray-400 mt-2">Vue d'ensemble de l'activité de la plateforme</p>
        </div>
        <a href="{{ url_for('admin.index') }}" class="btn-secondary">
            <i class="fas fa-arrow-left mr-2"></i>Retour
        </a>
    </div>

    <!-- Statistiques globales -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
        <div class="card-aiobi p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-400 text-sm">Total Utilisateurs</p>
                    <h3 class="text-3xl font-bold text-white mt-1">{{ total_users }}</h3>
                </div>
                <div class="p-3 bg-blue-500/20 rounded-lg">
                    <i class="fas fa-users text-2xl text-blue-500"></i>
                </div>
            </div>
        </div>

        <div class="card-aiobi p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-400 text-sm">Licences Actives</p>
                    <h3 class="text-3xl font-bold text-white mt-1">{{ active_licenses }}</h3>
                </div>
                <div class="p-3 bg-green-500/20 rounded-lg">
                    <i class="fas fa-key text-2xl text-green-500"></i>
                </div>
            </div>
        </div>

        <div class="card-aiobi p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-400 text-sm">Licences Expirées</p>
                    <h3 class="text-3xl font-bold text-white mt-1">{{ expired_licenses }}</h3>
                </div>
                <div class="p-3 bg-red-500/20 rounded-lg">
                    <i class="fas fa-exclamation-triangle text-2xl text-red-500"></i>
                </div>
            </div>
        </div>

        <div class="card-aiobi p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-400 text-sm">Nouveaux (7j)</p>
                    <h3 class="text-3xl font-bold text-white mt-1">{{ recent_users }}</h3>
                </div>
                <div class="p-3 bg-purple-500/20 rounded-lg">
                    <i class="fas fa-user-plus text-2xl text-purple-500"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Graphique d'inscriptions -->
        <div class="card-aiobi p-6">
            <h3 class="text-xl font-semibold text-white mb-4">
                <i class="fas fa-chart-line mr-2 text-blue-500"></i>
                Inscriptions (30 derniers jours)
            </h3>
            <canvas id="registrationChart"></canvas>
        </div>

        <!-- Répartition par type de licence -->
        <div class="card-aiobi p-6">
            <h3 class="text-xl font-semibold text-white mb-4">
                <i class="fas fa-chart-pie mr-2 text-purple-500"></i>
                Répartition des licences
            </h3>
            <canvas id="licenseChart"></canvas>
        </div>
    </div>

    <!-- Tableau détaillé des licences -->
    <div class="card-aiobi mt-6 p-6">
        <h3 class="text-xl font-semibold text-white mb-4">
            <i class="fas fa-table mr-2 text-green-500"></i>
            Détails par type de licence
        </h3>
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead class="border-b border-gray-700">
                    <tr>
                        <th class="text-left text-gray-400 py-3 px-4">Type</th>
                        <th class="text-left text-gray-400 py-3 px-4">Nombre</th>
                        <th class="text-left text-gray-400 py-3 px-4">Actives</th>
                        <th class="text-left text-gray-400 py-3 px-4">Expirées</th>
                        <th class="text-left text-gray-400 py-3 px-4">Pourcentage</th>
                    </tr>
                </thead>
                <tbody>
                    {% for license_type, count in license_stats %}
                    <tr class="border-b border-gray-700">
                        <td class="py-4 px-4">
                            <span class="text-white font-medium">{{ license_type.upper() }}</span>
                        </td>
                        <td class="py-4 px-4 text-gray-300">{{ count }}</td>
                        <td class="py-4 px-4">
                            <span class="text-green-500">
                                <i class="fas fa-check-circle mr-1"></i>
                                {{ license_status_counts[license_type]['active'] if license_type in license_status_counts else 0 }}
                            </span>
                        </td>
                        <td class="py-4 px-4">
                            <span class="text-red-500">
                                <i class="fas fa-times-circle mr-1"></i>
                                {{ license_status_counts[license_type]['expired'] if license_type in license_status_counts else 0 }}
                            </span>
                        </td>
                        <td class="py-4 px-4">
                            <div class="flex items-center gap-2">
                                <div class="flex-1 bg-gray-700 rounded-full h-2">
                                    <div class="bg-purple-500 h-2 rounded-full" 
                                         style="width: {{ (count / total_licenses * 100) if total_licenses > 0 else 0 }}%"></div>
                                </div>
                                <span class="text-gray-300 text-sm">
                                    {{ "%.1f" | format((count / total_licenses * 100) if total_licenses > 0 else 0) }}%
                                </span>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
// Données pour le graphique d'inscriptions
const registrationData = {
    labels: {{ registration_labels | tojson }},
    datasets: [{
        label: 'Nouvelles inscriptions',
        data: {{ registration_counts | tojson }},
        backgroundColor: 'rgba(139, 92, 246, 0.2)',
        borderColor: 'rgba(139, 92, 246, 1)',
        borderWidth: 2,
        fill: true,
        tension: 0.4
    }]
};

// Configuration du graphique d'inscriptions
const registrationConfig = {
    type: 'line',
    data: registrationData,
    options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
            legend: {
                display: false
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    stepSize: 1,
                    color: '#9CA3AF'
                },
                grid: {
                    color: '#374151'
                }
            },
            x: {
                ticks: {
                    color: '#9CA3AF'
                },
                grid: {
                    color: '#374151'
                }
            }
        }
    }
};

// Données pour le graphique de licences
const licenseData = {
    labels: {{ license_labels | tojson }},
    datasets: [{
        data: {{ license_counts | tojson }},
        backgroundColor: [
            'rgba(107, 114, 128, 0.8)',  // Trial - gray
            'rgba(59, 130, 246, 0.8)',   // Basic - blue
            'rgba(139, 92, 246, 0.8)',   // Premium - purple
            'rgba(234, 179, 8, 0.8)'     // Enterprise - yellow
        ],
        borderColor: [
            'rgba(107, 114, 128, 1)',
            'rgba(59, 130, 246, 1)',
            'rgba(139, 92, 246, 1)',
            'rgba(234, 179, 8, 1)'
        ],
        borderWidth: 2
    }]
};

// Configuration du graphique de licences
const licenseConfig = {
    type: 'doughnut',
    data: licenseData,
    options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
            legend: {
                position: 'bottom',
                labels: {
                    color: '#9CA3AF',
                    padding: 15,
                    font: {
                        size: 12
                    }
                }
            }
        }
    }
};

// Création des graphiques
const registrationChart = new Chart(
    document.getElementById('registrationChart'),
    registrationConfig
);

const licenseChart = new Chart(
    document.getElementById('licenseChart'),
    licenseConfig
);
</script>
{% endblock %}
