{% extends "base.html" %}

{% block title %}Créer une Licence - Aïobi{% endblock %}

{% block content %}
<div class="container-aiobi fade-in">
    <!-- Header -->
    <div class="flex items-center justify-between mb-8">
        <div>
            <h1 class="text-3xl font-bold text-white flex items-center">
                <i class="fas fa-plus-circle mr-3 text-purple-500"></i>
                Créer une nouvelle licence
            </h1>
        </div>
        <a href="{{ url_for('admin.licenses') }}" class="btn-secondary">
            <i class="fas fa-arrow-left mr-2"></i>Retour
        </a>
    </div>

    <div class="max-w-2xl mx-auto">
        <div class="card-aiobi">
            <form method="post">
                <!-- Utilisateur -->
                <div class="mb-6">
                    <label class="block text-gray-400 text-sm mb-2">Utilisateur *</label>
                    <select name="user_id" required class="input-aiobi w-full">
                        <option value="">Sélectionner un utilisateur</option>
                        {% for user in users %}
                        <option value="{{ user.id }}" {% if request.args.get('user_id') == user.id|string %}selected{% endif %}>
                            {{ user.username }} ({{ user.email }})
                        </option>
                        {% endfor %}
                    </select>
                    <p class="text-gray-500 text-xs mt-1">Choisissez l'utilisateur qui recevra cette licence</p>
                </div>

                <!-- Type de licence -->
                <div class="mb-6">
                    <label class="block text-gray-400 text-sm mb-2">Type de licence *</label>
                    <select name="license_type" required class="input-aiobi w-full" id="licenseType">
                        <option value="trial">Trial (Essai gratuit)</option>
                        <option value="basic">Basic</option>
                        <option value="premium">Premium</option>
                        <option value="enterprise">Enterprise</option>
                    </select>
                </div>

                <!-- Durée -->
                <div class="mb-6">
                    <label class="block text-gray-400 text-sm mb-2">Durée (jours) *</label>
                    <input type="number" name="duration_days" value="30" min="1" max="3650" required class="input-aiobi w-full">
                    <p class="text-gray-500 text-xs mt-1">Nombre de jours de validité (1-3650)</p>
                </div>

                <!-- Limites (affichage informatif) -->
                <div class="mb-6 p-4 bg-gray-700 rounded-lg">
                    <h3 class="text-white font-medium mb-3">Limites par type de licence</h3>
                    <div id="limitInfo" class="space-y-2 text-sm">
                        <div id="trialLimits" class="block">
                            <p class="text-gray-300"><i class="fas fa-robot mr-2 text-blue-500"></i>Modèles: <span class="text-white font-medium">3</span></p>
                            <p class="text-gray-300"><i class="fas fa-chart-line mr-2 text-green-500"></i>Prédictions: <span class="text-white font-medium">1000</span></p>
                        </div>
                        <div id="basicLimits" class="hidden">
                            <p class="text-gray-300"><i class="fas fa-robot mr-2 text-blue-500"></i>Modèles: <span class="text-white font-medium">10</span></p>
                            <p class="text-gray-300"><i class="fas fa-chart-line mr-2 text-green-500"></i>Prédictions: <span class="text-white font-medium">10000</span></p>
                        </div>
                        <div id="premiumLimits" class="hidden">
                            <p class="text-gray-300"><i class="fas fa-robot mr-2 text-blue-500"></i>Modèles: <span class="text-white font-medium">50</span></p>
                            <p class="text-gray-300"><i class="fas fa-chart-line mr-2 text-green-500"></i>Prédictions: <span class="text-white font-medium">100000</span></p>
                        </div>
                        <div id="enterpriseLimits" class="hidden">
                            <p class="text-gray-300"><i class="fas fa-robot mr-2 text-blue-500"></i>Modèles: <span class="text-white font-medium">Illimité</span></p>
                            <p class="text-gray-300"><i class="fas fa-chart-line mr-2 text-green-500"></i>Prédictions: <span class="text-white font-medium">Illimité</span></p>
                        </div>
                    </div>
                </div>

                <!-- Boutons -->
                <div class="flex gap-3">
                    <button type="submit" class="btn-primary flex-1">
                        <i class="fas fa-check mr-2"></i>Créer la licence
                    </button>
                    <a href="{{ url_for('admin.licenses') }}" class="btn-secondary flex-1 text-center">
                        <i class="fas fa-times mr-2"></i>Annuler
                    </a>
                </div>
            </form>
        </div>

        <!-- Clé générée (si existante) -->
        {% if generated_key %}
        <div class="card-aiobi mt-6 bg-green-500/10 border border-green-500/20">
            <div class="flex items-start">
                <div class="p-3 bg-green-500/20 rounded-lg mr-4">
                    <i class="fas fa-check-circle text-2xl text-green-500"></i>
                </div>
                <div class="flex-1">
                    <h3 class="text-white font-semibold mb-2">Licence créée avec succès !</h3>
                    <p class="text-gray-400 text-sm mb-3">La clé de licence suivante a été générée :</p>
                    <div class="flex items-center gap-2">
                        <code class="flex-1 px-4 py-3 bg-gray-800 text-green-400 rounded-lg font-mono text-lg">
                            {{ generated_key }}
                        </code>
                        <button onclick="copyToClipboard('{{ generated_key }}')" class="btn-secondary">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<script>
// Afficher les limites selon le type de licence
document.getElementById('licenseType').addEventListener('change', function() {
    const type = this.value;
    document.querySelectorAll('[id$="Limits"]').forEach(el => el.classList.add('hidden'));
    document.getElementById(type + 'Limits').classList.remove('hidden');
});

// Copier dans le presse-papier
function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        alert('Clé copiée dans le presse-papier !');
    });
}
</script>
{% endblock %}
