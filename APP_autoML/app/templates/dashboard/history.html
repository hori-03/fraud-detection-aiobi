{% extends "base.html" %}

{% block title %}Historique - Aïobi{% endblock %}

{% block content %}
<div class="space-y-6">
    <h1 class="text-3xl font-bold text-white">
        <i class="fas fa-history mr-3"></i>Historique des entraînements
    </h1>
    
    {% if pagination.items %}
    <!-- Filters -->
    <div class="card-aiobi p-4">
        <div class="flex items-center space-x-4">
            <label class="text-sm font-medium text-white">Filtrer par statut:</label>
            <select id="status-filter" 
                    onchange="window.location.href='?status=' + this.value"
                    class="input-aiobi text-sm">
                <option value="">Tous</option>
                <option value="completed">Terminé</option>
                <option value="training">En cours</option>
                <option value="failed">Échoué</option>
            </select>
        </div>
    </div>
    
    <!-- History Table -->
    <div class="card-aiobi overflow-hidden">
        <table class="min-w-full divide-y divide-gray-700">
            <thead class="bg-gray-800">
                <tr>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">
                        Modèle
                    </th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">
                        Type
                    </th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">
                        Status
                    </th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">
                        Date
                    </th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">
                        Durée
                    </th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">
                        ROC AUC
                    </th>
                    <th scope="col" class="relative px-6 py-3">
                        <span class="sr-only">Actions</span>
                    </th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-700">
                {% for item in pagination.items %}
                <tr class="hover:bg-gray-800">
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            <i class="fas fa-cube text-gray-400 mr-3"></i>
                            <div>
                                <div class="text-sm font-medium text-white">
                                    {{ item.model_name }}
                                </div>
                                <div class="text-sm text-gray-400">
                                    Target: {{ item.target_column }}
                                </div>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-900 bg-opacity-30 text-blue-400">
                            {{ item.model_type }}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        {% if item.status == 'completed' %}
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-900 bg-opacity-30 text-green-500">
                            <i class="fas fa-check-circle mr-1"></i> Terminé
                        </span>
                        {% elif item.status == 'training' %}
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-900 bg-opacity-30 text-yellow-500">
                            <i class="fas fa-spinner fa-spin mr-1"></i> En cours
                        </span>
                        {% elif item.status == 'failed' %}
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-900 bg-opacity-30 text-red-500">
                            <i class="fas fa-times-circle mr-1"></i> Échoué
                        </span>
                        {% endif %}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-400">
                        {{ item.created_at.strftime('%d/%m/%Y %H:%M') }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-400">
                        {% if item.training_duration %}
                            {{ item.training_duration|round(1) }}s
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        {% if item.metrics and item.status == 'completed' %}
                            <span class="font-bold text-white">
                                {{ (item.metrics.get('roc_auc', 0) * 100)|round(2) }}%
                            </span>
                        {% else %}
                            <span class="text-gray-400">-</span>
                        {% endif %}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        {% if item.status == 'completed' %}
                        <a href="{{ url_for('dashboard.model_detail', model_id=item.id) }}" 
                           class="text-white hover:underline">
                            Détails
                        </a>
                        {% elif item.status == 'failed' %}
                        <button onclick="showError({{ item.id }})" 
                                class="text-red-500 hover:text-red-400">
                            Voir erreur
                        </button>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <!-- Pagination -->
    {% if pagination.pages > 1 %}
    <div class="card-aiobi px-4 py-3 flex items-center justify-between border-t border-gray-700 sm:px-6">
        <div class="flex-1 flex justify-between sm:hidden">
            {% if pagination.has_prev %}
            <a href="?page={{ pagination.page - 1 }}" 
               class="relative inline-flex items-center px-4 py-2 border border-gray-600 text-sm font-medium rounded-md text-white bg-gray-800 hover:bg-gray-700">
                Précédent
            </a>
            {% endif %}
            {% if pagination.has_next %}
            <a href="?page={{ pagination.page + 1 }}" 
               class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-600 text-sm font-medium rounded-md text-white bg-gray-800 hover:bg-gray-700">
                Suivant
            </a>
            {% endif %}
        </div>
        <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
            <div>
                <p class="text-sm text-white">
                    Affichage 
                    <span class="font-medium">{{ ((pagination.page - 1) * 20) + 1 }}</span>
                    à 
                    <span class="font-medium">{{ min(pagination.page * 20, pagination.total) }}</span>
                    sur 
                    <span class="font-medium">{{ pagination.total }}</span>
                    résultats
                </p>
            </div>
            <div>
                <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px">
                    {% if pagination.has_prev %}
                    <a href="?page={{ pagination.page - 1 }}" 
                       class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-600 bg-gray-800 text-sm font-medium text-gray-400 hover:bg-gray-700">
                        <i class="fas fa-chevron-left"></i>
                    </a>
                    {% endif %}
                    
                    {% for p in range(1, pagination.pages + 1) %}
                        {% if p == pagination.page %}
                        <span class="relative inline-flex items-center px-4 py-2 border-2 border-white bg-gray-700 text-sm font-bold text-white">
                            {{ p }}
                        </span>
                        {% elif p <= 3 or p > pagination.pages - 3 or (p >= pagination.page - 1 and p <= pagination.page + 1) %}
                        <a href="?page={{ p }}" 
                           class="relative inline-flex items-center px-4 py-2 border border-gray-600 bg-gray-800 text-sm font-medium text-white hover:bg-gray-700">
                            {{ p }}
                        </a>
                        {% elif p == 4 or p == pagination.pages - 3 %}
                        <span class="relative inline-flex items-center px-4 py-2 border border-gray-600 bg-gray-800 text-sm font-medium text-white">
                            ...
                        </span>
                        {% endif %}
                    {% endfor %}
                    
                    {% if pagination.has_next %}
                    <a href="?page={{ pagination.page + 1 }}" 
                       class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                        <i class="fas fa-chevron-right"></i>
                    </a>
                    {% endif %}
                </nav>
            </div>
        </div>
    </div>
    {% endif %}
    
    {% else %}
    <!-- Empty State -->
    <div class="bg-white shadow rounded-lg p-12 text-center">
        <i class="fas fa-inbox text-gray-400 text-6xl mb-4"></i>
    <h3 class="text-xl font-semibold text-white mb-2">Aucun historique</h3>
        <p class="text-gray-500">Vos entraînements apparaîtront ici</p>
    </div>
    {% endif %}
</div>

<!-- Error Modal -->
<div id="error-modal" class="hidden fixed z-10 inset-0 overflow-y-auto">
    <div class="flex items-center justify-center min-h-screen px-4">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity"></div>
        
        <div class="bg-gray-800 rounded-lg overflow-hidden shadow-xl transform transition-all max-w-lg w-full">
            <div class="bg-red-600 px-4 py-3">
                <h3 class="text-lg font-semibold text-white">
                    <i class="fas fa-exclamation-triangle mr-2"></i>Détails de l'erreur
                </h3>
            </div>
            <div class="px-4 py-5">
                <p id="error-message" class="text-sm text-white whitespace-pre-wrap"></p>
            </div>
            <div class="bg-gray-900 px-4 py-3 flex justify-end">
                <button onclick="closeErrorModal()" 
                        class="px-4 py-2 bg-gray-700 text-white rounded-md hover:bg-gray-600">
                    Fermer
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Store error messages
const errorMessages = {};
{% for item in pagination.items %}
    {% if item.status == 'failed' and item.error_message %}
    errorMessages[{{ item.id }}] = {{ item.error_message|tojson }};
    {% endif %}
{% endfor %}

function showError(itemId) {
    const message = errorMessages[itemId] || 'Aucun message d\'erreur disponible';
    document.getElementById('error-message').textContent = message;
    document.getElementById('error-modal').classList.remove('hidden');
}

function closeErrorModal() {
    document.getElementById('error-modal').classList.add('hidden');
}
</script>
{% endblock %}
